{% extends 'base.html' %}
{% load widget_tweaks %}
{% block title %}تحديث البيانات المالية - مجبل الراعي الحديث{% endblock %}

{% block content %}
<div class="container">
    <h1 class="text-center mb-4">تحديث البيانات المالية للحجز رقم {{ reservation.reservation_number }}</h1>

    <!-- عرض معلومات الحجز الأساسية -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white d-flex align-items-center">
            <i class="bi bi-info-circle-fill me-2"></i> معلومات الحجز
        </div>
        <div class="card-body">
            <p><strong><i class="bi bi-person-fill me-1"></i> اسم العميل:</strong> {{ reservation.customer_name }}</p>
            <p><strong><i class="bi bi-hammer me-1"></i> اسم النجار:</strong> {{ reservation.carpenter_name }}</p>
            <p><strong><i class="bi bi-layers-fill me-1"></i> نوع الخرسانة:</strong> {{ reservation.concrete_type }}</p>
            <p><strong><i class="bi bi-bricks me-1"></i> كمية الخرسانة:</strong> {{ reservation.concrete_quantity }} متر مكعب</p>
            <p><strong><i class="bi bi-geo-alt-fill me-1"></i> موقع الصب:</strong> {{ reservation.site_location }}</p>
            <p><strong><i class="bi bi-chat-left-dots-fill me-1"></i> ملاحظات العميل:</strong> {{ reservation.additional_notes }}</p>
            <p><strong><i class="bi bi-telephone-fill me-1"></i> رقم الهاتف:</strong> {{ reservation.phone_number }}</p>
        </div>
    </div>

    <!-- عرض الرصيد المتبقي والإجماليات -->
    <div class="alert alert-info d-flex align-items-center">
        <i class="bi bi-currency-dollar me-2"></i>
        <div>
            <strong>إجمالي التكلفة الإجمالية:</strong> {{ total_gross_amount_sum }} دولار أمريكي<br>
            <strong>إجمالي الخصومات:</strong> {{ total_discount_sum }} دولار أمريكي<br>
            <strong>إجمالي المدفوعات:</strong> {{ total_payments_sum }} دولار أمريكي<br>
            <strong>إجمالي الرصيد المتبقي:</strong> <span id="remaining_balance_display">{{ total_remaining_sum }}</span> دولار أمريكي
        </div>
    </div>

    <!-- عرض رسائل النجاح أو الخطأ -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-circle-fill me-2"></i>{{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="إغلاق"></button>
            </div>
        {% endfor %}
    {% endif %}

    <div class="row">
        <!-- نموذج تحديث البيانات المالية -->
        <div class="col-md-6">
            <h3 class="mb-3"><i class="bi bi-pencil-square me-1"></i> تحديث البيانات المالية</h3>
            <form method="post" id="financial_form" class="shadow-sm p-4 mb-4 bg-white rounded">
                {% csrf_token %}
                {{ financial_form.non_field_errors }}
                <div class="mb-3">
                    <label for="{{ financial_form.price_per_unit.id_for_label }}" class="form-label">السعر للوحدة (دولار أمريكي)</label>
                    {{ financial_form.price_per_unit|add_class:"form-control" }}
                </div>
                <div class="mb-3">
                    <label for="{{ financial_form.discount.id_for_label }}" class="form-label">الخصم (دولار أمريكي)</label>
                    {{ financial_form.discount|add_class:"form-control" }}
                </div>
                <div class="mb-3">
                    <label for="{{ financial_form.payments.id_for_label }}" class="form-label">مجموع الدفعات المدفوعة (دولار أمريكي)</label>
                    {{ financial_form.payments|add_class:"form-control" }}
                </div>
                <div class="mb-3">
                    <label for="{{ financial_form.concrete_quantity.id_for_label }}" class="form-label">كمية الخرسانة النهائية (متر مكعب)</label>
                    {{ financial_form.concrete_quantity|add_class:"form-control" }}
                </div>
                <div class="mb-3">
                    <label for="{{ financial_form.concrete_type.id_for_label }}" class="form-label">عيار الخرسانة النهائية</label>
                    {{ financial_form.concrete_type|add_class:"form-select" }}
                </div>
                <div class="form-check mb-3">
                    {{ financial_form.is_completed }}
                    <label class="form-check-label" for="{{ financial_form.is_completed.id_for_label }}">
                        تم اكتمال الحجز
                    </label>
                </div>
                <div class="mb-3">
                    <label for="{{ financial_form.completion_date.id_for_label }}" class="form-label">تاريخ اكتمال الحجز</label>
                    {{ financial_form.completion_date|add_class:"form-control" }}
                </div>
                <button type="submit" name="update_financial" class="btn btn-primary w-100">تحديث البيانات المالية</button>
            </form>
        </div>

        <!-- نموذج تسجيل دفعة جديدة -->
        <div class="col-md-6">
            <h3 class="mb-3"><i class="bi bi-cash-stack me-1"></i> تسجيل دفعة جديدة</h3>
            <form method="post" class="shadow-sm p-4 mb-4 bg-white rounded">
                {% csrf_token %}
                {{ payment_form.non_field_errors }}
                <div class="mb-3">
                    <label for="{{ payment_form.payment_amount.id_for_label }}" class="form-label">قيمة الدفعة (دولار أمريكي)</label>
                    {{ payment_form.payment_amount|add_class:"form-control" }}
                </div>
                <button type="submit" name="record_payment" class="btn btn-success w-100">تسجيل الدفعة</button>
            </form>
        </div>
    </div>
</div>

<!-- JavaScript لتحديث الرصيد المتبقي تلقائيًا -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const pricePerUnitInput = document.getElementById('{{ financial_form.price_per_unit.id_for_label }}');
        const discountInput = document.getElementById('{{ financial_form.discount.id_for_label }}');
        const paymentsInput = document.getElementById('{{ financial_form.payments.id_for_label }}');
        const concreteQuantityInput = document.getElementById('{{ financial_form.concrete_quantity.id_for_label }}');
        const remainingBalanceDisplay = document.getElementById('remaining_balance_display');

        function calculateRemainingBalance() {
            const pricePerUnit = parseFloat(pricePerUnitInput.value) || 0;
            const discount = parseFloat(discountInput.value) || 0;
            const payments = parseFloat(paymentsInput.value) || 0;
            const concreteQuantity = parseFloat(concreteQuantityInput.value) || 0;

            const totalCost = pricePerUnit * concreteQuantity;
            const discountedCost = totalCost - discount;
            const remainingBalance = discountedCost - payments;

            remainingBalanceDisplay.textContent = remainingBalance.toFixed(2);
        }

        // استدعاء الدالة عند تغيير أي من الحقول المالية
        pricePerUnitInput.addEventListener('input', calculateRemainingBalance);
        discountInput.addEventListener('input', calculateRemainingBalance);
        paymentsInput.addEventListener('input', calculateRemainingBalance);
        concreteQuantityInput.addEventListener('input', calculateRemainingBalance);

        // استدعاء الدالة عند تحميل الصفحة لتحديث الرصيد الحالي
        calculateRemainingBalance();
    });
</script>
{% endblock %}